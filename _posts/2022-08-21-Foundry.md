---
layout: post
title:  "Foundry를 통한 스마트 컨트렉트 테스트"
date:   2022-08-21 14:03:31 +0900
categories: blockchain
---

### Foundry
기존의 스마트컨트렉트 개발은 [Truffle], [hardhat] 등의 툴을 사용하여 개발을 하였습니다. 특히 테스트를 위해선 Hardhat을 통하여 많이 진행했는데, Paradim에서 개발한 [Foundry]가 이러한 테스트에 새로운 대안으로 등장하였습니다.


Foundry는 쉽게 설명하자면 Solidity 언어를 Solidity로 테스트가 가능하게 도와주는 툴입니다. 기존의 툴들을 통해 테스트를 진행하기 위해서는테스트 코드를  Javascript 혹은 Typescript로 작성해야했기 때문에 많은 의존성과 config들이 필요하였습니다. 예시로, 자바스크립트에서 테스트할 경우엔 BigNumber 라이브러리를 써가며 숫자를 다루는 불편함이 있는데 Foundry를 쓸 경우 이런 불편함이 사라집니다.  

Foundry의 Forge를 통한 간단한 테스트 코드 예시는 아래와 같습니다.

```solidity
contract Foo {
  uint256 public x = 1;
  function set(uint256 _x) external {
    x = _x;
  }

  function double() external {
    x = 2 * x;
  }
}

contract FooTest {
  Foo foo;

  // The state of the contract gets reset before each
  // test is run, with the setUp() function being called
  // each time after deployment. Think of this like a JavaScript
  // beforeEach block
  function setUp() public {
    foo = new Foo();
  }

  // A simple unit test
  function testDouble() public {
    require(foo.x() == 1);
    foo.double();
    require(foo.x() == 2);
  }

  // A failing unit test (function name starts with testFail)
  function testFailDouble() public {
    require(foo.x() == 1);
    foo.double();
    require(foo.x() == 4);
  }
}
```

### 퍼징 테스트 지원 (무작위 데이터 입력)
테스트를 하다보면 생각하지도 못한 에러사항이 발생하게됩니다. 사람이 모든 테스트 영역을 커버하기는 쉽지 않으므로 무작위의 input을 통해 자동화된 테스트를 수행하는 퍼징 기능이 필요할 수 있습니다. 아래는 Foundry에서 지원하는 퍼징 기능의 한 예시입니다.

```solidity
function testDoubleWithFuzzing(uint256 x) public {
  foo.set(x);
  require(foo.x() == x);
  foo.double();
  require(foo.x() == 4 * x);
}
```

위에서 x에 자동으로 여러 값을 대입해 테스트하고 에러가 발생할 시 카운터 예제 값인 x를 아래와같이 보여줍니다.

```
[FAIL. Counterexample: calldata=0x44735ef10000000000000000000000000000000000000000000000000000000000000001, args=[Uint(1)]] testDoubleWithFuzzingCounterExample (gas: [fuzztest])
```

### VM 상태 값 변경 지원

### Reference
1. [Paradim's Blog Post for Foundry]

[Paradim's Blog post for Foundry]: https://www.paradigm.xyz/2021/12/introducing-the-foundry-ethereum-development-toolbox
[Introduce]: https://www.paradigm.xyz/2021/12/introducing-the-foundry-ethereum-development-toolbox
[Foundry]: https://github.com/foundry-rs/foundry
[Hardhat]: https://hardhat.org/
[Truffle]: https://trufflesuite.com/
